# Hemache

変化をまとめてチェックする、変化まとめチェッカー Hemache。
(HEnka MAtome CHEker)

- 複数のログファイルを一気に読み込んで変化のあった日時（or 日付）だけをまとめた TSV ファイル（DBファイル）を作る (build mode)。
- 新たなログファイルでDBファイルのアップデートができる (update mode)。

## Options

```
-i FILENAME, -input FILENAME : アップデート用に読み込むログファイルを1つ指定 (update mode)
-d FILENAME, -db FILENAME : アップデートするDBファイルを指定 (update mode)
-D, -delete : 途中にある DELETED の削除を行う
-l STRING, -label STRING : DELETED のラベル文字列を指定する (default は "[DELETED]")
```
詳細は後述。

## 使い方

- build mode:
  - ファイル群からDBファイルを作る。
  - 入力: ファイル名リスト(stdin)
  - 出力: DBファイル(stdout)
- update mode:
  - ログファイル1つを読み込み、DBファイルをアップデートする。
  - 入力: ログファイル("-i"), DBファイル("-d")
  - 出力: DBファイル(stdout)
- clearn mode:
  - DBファイルを読み込み dedup などのクリーニングを行う。
  - 入力: DBファイル("-d")
  - 出力: DBファイル(stdout)

build mode:
```
% ls test/dat 
20220101.tsv  20220102.tsv  20220103.tsv  20220104.tsv  20220105.tsv
% find test/dat/ -name '*.tsv' | ./hemache.pl > db.tsv
% cat db.tsv
A001	20220101,200
A002	20220102,10	20220101,0
A010	20220105,[DELETED]	20220103,0	20220102,90	20220101,100
A015	20220104,20	20220103,30	20220101,20
A029	20220105,20	20220102,25	20220101,20
A034	20220101,70
A037	20220103,[DELETED]	20220101,250
A040	20220103,[DELETED]	20220102,10	20220101,12
A048	20220101,80
A049	20220104,110	20220101,100
A051	20220105,2	20220103,1
A056	20220105,[DELETED]	20220104,10
```

update mode:
```
% ./hemache.pl -i a -d db.tsv -i test/new/20220106.tsv > db-new.tsv
% cat db-new.tsv
A001	20220101,200
A002	20220106,15	20220102,10	20220101,0
A010	20220105,[DELETED]	20220103,0	20220102,90	20220101,100
A015	20220104,20	20220103,30	20220101,20
A029	20220105,20	20220102,25	20220101,20
A034	20220101,70
A037	20220106,100	20220103,[DELETED]	20220101,250
A040	20220103,[DELETED]	20220102,10	20220101,12
A048	20220101,80
A049	20220106,[DELETED]	20220104,110	20220101,100
A051	20220105,2	20220103,1
A056	20220105,[DELETED]	20220104,10
A057	20220106,30
% cp -p db-new.tsv db.tsv
```

"-D" オプションで、途中にある DELETED の削除を行う。

例：途中にある DELETED を消す(ID1,ID2)。前後が同じだったら一つにする(ID2)。先頭はそのまま(ID3)。
```
BEFORE: ID1 20220129,105,1 20220128,[DELETED] 20211226,209,2 20211212,105,1
AFTER : ID1 20220129,105,1 20211226,209,2 20211212,105,1
```
```
BEFORE: ID2 20220129,660,7 20220128,[DELETED] 20220107,660,7 20211219,99,1
AFTER : ID2 20220107,660,7 20211219,99,1
```
```
BEFORE: ID3 20220128,[DELETED] 20211219,99,1
AFTER : ID3 20220128,[DELETED] 20211219,99,1
```

## 使用するファイル

- ログファイル
  - ファイル名には YYYYMMDDHH or YYYYMMDD が含まれなければならない。
    - 例: "2022020518-log.txt" "log/20220228.tsv.gz"
  - FORMAT: ```^ID[\t]CONT([\t].*)*$```
    - 例: ```^8182360051[\t]200,10[\t]...```
    - 第1,2カラムのみ使う。3カラム以降は無視される。
- DBファイル
  - FORMAT: ```^ID[\t]YMDH,CONT([\t]YMDH,CONT)*$```
    - 例: ```^A002[\t]20220106,15[\t]20220102,10[\t]20220101,0$```
    - ファイルから消えたら、"[DELEATED]" と表示される。
    - 例: ```^A040[\t]20220103,[DELETED][\t]20220102,10[\t]20220101,12$```


log file sample:
```
A001	200
A002	0
A010	100
A015	20
A029	20
A034	70
A037	250
A040	12
A048	80
A049	100
```

DB file sample:
```
A001	20220101,200
A002	20220102,10	20220101,0
A010	20220105,[DELETED]	20220103,0	20220102,90	20220101,100
A015	20220104,20	20220103,30	20220101,20
A029	20220105,20	20220102,25	20220101,20
A034	20220101,70
A037	20220103,[DELETED]	20220101,250
A040	20220103,[DELETED]	20220102,10	20220101,12
A048	20220101,80
A049	20220104,110	20220101,100
A051	20220105,2	20220103,1
A056	20220105,[DELETED]	20220104,10
```

## 未解決問題

- 同じ日付で変化がある場合、複数記録されてしまう → 仕様ということでよいか
- ログファイルのカラム指定はできた方がよさそう
  - ID と value の位置指定
  - ID は第1カラム固定で良いかな

